gl_optix_composite
==================

The OpenGL + OptiX Compositing sample demonstrates how to mix interactive OpenGL rendering with OptiX overlay compositing. This particular example demonstrates 8x sub-sampled, raytraced hard shadows which are composited with an OpenGL wireframe model. The shadows are computed by OptiX, and the results are placed into an OpenGL texture which represents a screen-space shadow mask. During the final OpenGL rendering past, the shadow mask texture is evaluated to give the fractional shadow factor.

While this sample demonstrates hard shadow compositing, the technique is not limited to shadows, and may be used for reflections, refractions, and other effects generated by GPU OptiX raytracing.

![sample screenshot](https://github.com/nvpro-samples/gl_optix_composite/blob/master/docs/optix_shadow8.png)

#### Compositing Technique

The method of compositing OpenGL with OptiX consists of two GPU pathways which are then composited together. The steps for compositing are:<br>
1) OptiX is initialized<br>
2) Scene geometry is loaded into OptiX<br>
3) Scene geometry is also loaded  in an OpenGL VBO<br>
4) The OptiX scene is rendered into an OptiX buffer, by casting 1 primary ray, and then up to 8 shadow rays per fragment. Each shadow ray contributes a fractional intensity to a given pixel.<br>
5) The OptiX buffer is then transfered to an OpenGL texture using a device-to-device copy<br>
6) Next, the scene is rendered using OpenGL<br>
7) Finally, a GLSL shader looks up the fractional shadow mask value, and uses it during shading calculations.<br>

![sample screenshot](https://github.com/nvpro-samples/gl_optix_composite/blob/master/docs/optix_composite1.jpg)

The OptiX and OpenGL rendering steps happen sequentially, but within these steps OptiX is using CUDA for parallel raytracing, and OpenGL is using the GPU graphics pipeline for rendering. The OpenGL render also uses MSAA, so that the final image is anti-aliased, however this does not give anti-aliased shadows only anti-aliased polygons.

#### Shadowing Technique

Higher quality hard shadows are achieved by multi-sampling the shadow rays within a given fragment. With 1 shadow ray/pixel (spp), each pixel casts a single ray toward the light source. With only 1 spp we see shadow aliasing artifacts.

![sample screenshot](https://github.com/nvpro-samples/gl_optix_composite/blob/master/docs/optix_shadow1x.png)
![sample screenshot](https://github.com/nvpro-samples/gl_optix_composite/blob/master/docs/optix_shadow8x.png)

These images compare 1 spp and 8 spp hard shadows. By increasing the number of shadow rays, we can achieve high quality interactive hard shadows. While this requires 8x more rays, many of these will be close together and OptiX will utilize the spatial coherency.

![sample screenshot](https://github.com/nvpro-samples/gl_optix_composite/blob/master/docs/optix_composite2.jpg)

To generate multiple shadow rays, these rays must be contained within a single pixel/fragment. In this demo, the pixel is projected into world-space at the hit point of the primary ray. At this point, we use the normal to determine the orientation of the fragment, and construct a sampling disc oriented to contain the fragment. 8x random points are then generated inside this disc, pushed slightly along the geometry normal N in order to reduce biasing artifacts. These points represent the starting points of the shadow rays, while all rays will point toward a point light source. By averaging these ray contributions, we can determine the fractional shadow value for a given pixel.

#### Requirements

Requirements:<br>
- Visual Studio 2010/2012<br>
- CUDA 5.5 Toolkit<br>
To run this sample, you must install the CUDA 5.5 Toolkit. https://developer.nvidia.com/cuda-toolkit-55-archive
 (Other versions of CUDA are not yet supported).
- OptiX 3.6.3 SDK is needed from the shared_optix repo, so no external libraries are needed aside from CUDA 5.5.

#### How to Build & Run

Quick build instructions:

1) Clone the following NVPro-samples repositories:
  - //github.com/nvpro-samples/build_all.git
  - //github.com/nvpro-samples/shared_optix.git
  - //github.com/nvpro-samples/shared_sources.git
  - //github.com/nvpro-samples/gl_optix_composite.git

2) Download and install CMake 2.8.2. (http://www.cmake.org/files/v2.8/cmake-2.8.2.zip)

3) Open CMake-gui, and generate Visual Studio projects:
  - Source code to: /nvpro_ samples/build_all
  - Build fodler: /nvpro_samples/build
  - Click Configure and select "Use Visual Studio 10 Win64"
  - Click Generate

4) Open the nvpro_samples.sln into Visual Studio 2010, and Build All!

5) Select the gl_ optix_composite samples as the Startup project (right click on project, select Set as StartUp Project)

6) Click Run!








